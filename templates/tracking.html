<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>OptiFleet Tracking</title>
  <style>
    body{font-family:system-ui;margin:0;background:#0b132b;color:#fff}
    .card{max-width:640px;margin:16px auto;background:#1c2541;padding:16px;border-radius:12px}
    label{font-size:12px;opacity:.85}
    input,button{width:100%;padding:10px;border-radius:8px;border:0;margin:6px 0 12px}
    button{background:#3a86ff;color:#fff;cursor:pointer}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .ok{color:#06d6a0}.err{color:#ff6b6b}.muted{opacity:.85;font-size:12px}
  </style>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="card">
    <h2>Rastreamento — OptiFleet</h2>

    <label>ID do veículo</label>
    <input id="vehicle" placeholder="ex.: V1">

    <label>Token</label>
    <input id="token" placeholder="Cole o token fornecido">

    <div class="row">
      <button onclick="start()">Iniciar</button>
      <button onclick="stop()">Parar</button>
    </div>

    <div id="status" class="muted">Aguardando…</div>
    <pre id="log" style="white-space:pre-wrap;font-size:12px;"></pre>



    <!-- Lista de alarmes -->
    <h3 style="margin-top:16px">Alarmes</h3>
    <ul id="alarms" style="font-size:12px;line-height:1.4;margin:0;padding-left:18px"></ul>

    <!-- Gráfico de Velocidade -->
    <h3>Velocidade</h3>
    <canvas id="speedChart" height="120" style="margin-top:10px;background:#111827;border-radius:8px"></canvas>

  </div>

  <script>
  // ----- helpers básicos -----
  let watchId = null;
  let lastSent = 0;
  let chart = null;
  let refreshTimer = null;

  function qs(k){ return new URLSearchParams(location.search).get(k); }
  function log(t){
    const pre = document.getElementById('log');
    pre.textContent = (new Date()).toLocaleTimeString()+" - "+t+"\n"+pre.textContent;
  }
  function setStatus(html){ document.getElementById('status').innerHTML = html; }

  // ----- envio de posição ao backend -----
  async function sendFix(vId, token, lat, lon, speed){
    const now = Date.now();
    if(now - lastSent < 5000) return; // 1 fix/5s
    lastSent = now;

    const payload = {
      vehicle_id: vId,                // string ex.: "V1"
      lat, lon,
      speed_kmh: (speed || 0) * 3.6,  // m/s -> km/h
      odometer_km: 0, fuel_pct: 0, engine_temp: 0, obd_alerts: 0
    };

    try{
      const res = await fetch('/api/telemetry', {
        method:'POST',
        headers:{'Content-Type':'application/json','Authorization':'Bearer '+token},
        body: JSON.stringify(payload)
      });
      setStatus(res.ok ? '<span class="ok">Enviado ✓</span>' : '<span class="err">Falha</span>');
    }catch(e){
      setStatus('<span class="err">Falha de rede</span>');
    }
  }

  // ----- gráfico de velocidade (usa /api/telemetry/history já existente) -----
  async function loadSpeed(vid, hours=6){
    try{
      const r = await fetch(`/api/telemetry/history?vehicle_id=${encodeURIComponent(vid)}&hours=${hours}`);
      if(!r.ok) return;
      const pts = await r.json(); // [{vehicle_id, lat, lon, ts, speed, bearing}]
      const labels = pts.map(d => d.ts);
      const speeds = pts.map(d => d.speed);

      const ctx = document.getElementById('speedChart').getContext('2d');
      if(chart){ chart.destroy(); }
      chart = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets: [{ label: `Velocidade ${vid}`, data: speeds, tension: 0.2 }]},
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true, title: { display: true, text: 'km/h' } },
            x: { display: false }
          }
        }
      });
    }catch(e){
      // silencia erros
    }
  }

  // ----- alarmes (/api/telemetry/events) -----
  async function loadAlarms(vid, hours=2){
    try{
      const r = await fetch(`/api/telemetry/events?vehicle_id=${encodeURIComponent(vid)}&hours=${hours}&overspeed=100&offroute_km=0.3`);
      if(!r.ok) return;
      const events = await r.json();
      const el = document.getElementById('alarms');
      el.innerHTML = '';
      events.forEach(e=>{
        const li = document.createElement('li');
        if(e.type==='overspeed')      li.textContent = `[${e.ts}] ${e.vehicle_id}: excesso de velocidade (${e.value} km/h)`;
        else if(e.type==='off_route') li.textContent = `[${e.ts}] ${e.vehicle_id}: fora da rota (${e.distance_km} km)`;
        else if(e.type==='stop')      li.textContent = `[${e.ts}] ${e.vehicle_id}: parada ${e.minutes} min`;
        else if(e.type==='harsh_turn')li.textContent = `[${e.ts}] ${e.vehicle_id}: curva brusca (${e.delta_deg}°)`;
        else                          li.textContent = `[${e.ts}] ${e.vehicle_id}: ${e.type}`;
        el.appendChild(li);
      });
    }catch(e){
      // silencia erros
    }
  }

  // ----- controlar início/parada -----
  function start(){
    const vId = document.getElementById('vehicle').value.trim();
    const token = document.getElementById('token').value.trim();
    if(!vId || !token){ setStatus('<span class="err">Preencha veículo e token.</span>'); return; }
    if(!navigator.geolocation){ setStatus('<span class="err">Sem geolocalização.</span>'); return; }

    // inicia watchPosition
    watchId = navigator.geolocation.watchPosition(
      pos => {
        const {latitude, longitude, speed} = pos.coords;
        setStatus(`Lat:${latitude.toFixed(6)} Lon:${longitude.toFixed(6)} Vel:${(speed||0).toFixed(1)} m/s`);
        sendFix(vId, token, latitude, longitude, speed||0);
      },
      err => setStatus('<span class="err">GPS: '+err.message+'</span>'),
      {enableHighAccuracy:true, maximumAge:2000, timeout:10000}
    );
    log('tracking iniciado');

    // carrega e agenda atualizações (gráfico + alarmes)
    loadSpeed(vId, 6);
    loadAlarms(vId, 2);
    if(refreshTimer) clearInterval(refreshTimer);
    refreshTimer = setInterval(() => {
      loadSpeed(vId, 6);
      loadAlarms(vId, 2);
    }, 30000); // 30s
  }

  function stop(){
    if(watchId !== null){
      navigator.geolocation.clearWatch(watchId);
      watchId = null;
      log('tracking parado');
      setStatus('Parado');
    }
    if(refreshTimer){
      clearInterval(refreshTimer);
      refreshTimer = null;
    }
  }

  // auto-start via querystring ?vehicle=V1&token=...
  window.addEventListener('load', ()=>{
    const v = qs('vehicle'), t = qs('token');
    if(v) document.getElementById('vehicle').value = v;
    if(t) document.getElementById('token').value = t;
    if(v && t) start();
  });
  </script>
</body>
</html>
