<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8">
<title>OptiFleet — Telemetria</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<style>
  :root{--bg:#0b132b;--card:#1c2541;--muted:#a0aec0}
  body{margin:0;font-family:system-ui,Arial;background:var(--bg);color:#fff}
  .wrap{max-width:1200px;margin:18px auto;padding:0 14px}
  .grid{display:grid;grid-template-columns:2fr 1fr;gap:14px}
  .card{background:var(--card);border-radius:12px;padding:12px}
  #map{height:68vh;border-radius:10px}
  ul{list-style:none;padding:0;margin:0}
  li{padding:8px;border-bottom:1px solid rgba(255,255,255,.1);display:flex;align-items:center;gap:8px}
  li:hover{background:rgba(255,255,255,.05);cursor:pointer}
  .muted{color:var(--muted);font-size:12px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:8px 0}
  .pill{background:#243b74;border-radius:999px;padding:4px 10px;font-size:12px}
  button{background:#3751ff;color:#fff;border:0;border-radius:8px;padding:8px 12px;cursor:pointer}
  button:disabled{opacity:.5;cursor:not-allowed}
</style>
</head>
<body>
<div class="wrap">
  <h1>Telemetria em tempo real</h1>
  <div class="grid">
    <div class="card">
      <div id="map"></div>
      <div id="hint" class="muted" style="margin-top:6px">
        Selecione os veículos ao lado para acompanhar em tempo real. Clique no nome para ver o traçado recente.
      </div>
      <div class="row">
        <span class="pill" id="status">rodando…</span>
        <button id="fitBtn">Enquadrar frota</button>
      </div>
    </div>
    <div class="card">
      <h3>Veículos</h3>
      <div class="muted" style="margin-bottom:6px">Marque os que deseja acompanhar no mapa.</div>
      <ul id="veh_list"></ul>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
/* ====== MAPA ====== */
const map = L.map('map').setView([-15.78,-47.93], 4);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19}).addTo(map);

const markers = {};      // vehicle_id -> L.Marker
let trackLayer = null;   // polyline do traçado
let firstFitDone = false;

/* ====== UTILS ====== */
function speedOf(d){ return Number(d.speed ?? d.speed_kmh ?? 0); } // compat
function latOf(d){ return Number(d.lat); }
function lonOf(d){ return Number(d.lon); }

function markerIconBySpeed(v){
  const s = speedOf(v);
  const color = s > 2 ? "#2bd576" : "#e6b800"; // andando x parado
  // pin SVG simples
  return L.divIcon({
    className: "veh-pin",
    html: `<svg width="22" height="22" viewBox="0 0 24 24" fill="${color}" stroke="black" stroke-width="0.5"><circle cx="12" cy="12" r="8"/></svg>`,
    iconSize: [22,22],
    iconAnchor: [11,11]
  });
}

function upsertMarkerFromObj(v){
  if (!v || isNaN(latOf(v)) || isNaN(lonOf(v))) return;
  const vid = v.id ?? v.vehicle_id;
  const key = String(vid);
  if (!markers[key]){
    markers[key] = L.marker([latOf(v), lonOf(v)], {icon: markerIconBySpeed(v)}).addTo(map)
      .bindPopup(`${v.name || ('Veículo '+key)}<br>Vel: ${speedOf(v).toFixed(0)} km/h<br>${v.ts || ''}`);
  }else{
    markers[key].setLatLng([latOf(v), lonOf(v)]);
    markers[key].setIcon(markerIconBySpeed(v));
    markers[key].setPopupContent(`${v.name || ('Veículo '+key)}<br>Vel: ${speedOf(v).toFixed(0)} km/h<br>${v.ts || ''}`);
  }
}

/* ====== LISTA E SELEÇÃO ====== */
const listEl = document.getElementById('veh_list');

function rowForVehicle(v){
  const vid = v.id ?? v.vehicle_id;
  const li = document.createElement('li');
  li.dataset.vid = String(vid);
  const cb = document.createElement('input');
  cb.type = 'checkbox';
  cb.checked = true; // marca por padrão
  cb.addEventListener('click', (e)=> e.stopPropagation());
  li.appendChild(cb);

  const label = document.createElement('span');
  label.textContent = `${v.name || 'Veículo'} ${vid}`;
  li.appendChild(label);

  const badge = document.createElement('span');
  badge.className = 'pill';
  badge.textContent = 'ver traçado';
  badge.addEventListener('click', (e)=>{ e.stopPropagation(); showTrack(vid); });
  li.appendChild(badge);

  li.addEventListener('click', ()=> showTrack(vid));
  return li;
}

function getSelectedIds(){
  const ids = [];
  listEl.querySelectorAll('li').forEach(li=>{
    const cb = li.querySelector('input[type=checkbox]');
    if(cb && cb.checked) ids.push(Number(li.dataset.vid));
  });
  return ids;
}

/* ====== CARREGAMENTO INICIAL: /api/telemetry/latest ======
   Preenche lista e desenha markers iniciais */
async function loadLatest(){
  const r = await fetch('/api/telemetry/latest');
  const data = await r.json(); // [{vehicle_id,lat,lon,speed,fuel,ts}]
  listEl.innerHTML = '';
  const bounds = [];
  data.forEach(d=>{
    // linha da lista
    listEl.appendChild(rowForVehicle(d));
    // marcador
    upsertMarkerFromObj(d);
    bounds.push([latOf(d), lonOf(d)]);
  });
  if(bounds.length && !firstFitDone){
    map.fitBounds(bounds, {padding:[30,30]});
    firstFitDone = true;
  }
}
loadLatest();

/* ====== BATCH POLLING: /api/telemetry/last_many ======
   Atualiza em tempo real os veículos selecionados */
async function tickMany(ids){
  if(!ids.length) return;
  const r = await fetch('/api/telemetry/last_many?ids='+ids.join(','));
  if(!r.ok) return;
  const arr = await r.json(); // [{id,name,imei,lat,lon,speed,ts}]
  const bounds = [];
  arr.forEach(v=>{
    upsertMarkerFromObj(v);
    if(!isNaN(latOf(v)) && !isNaN(lonOf(v))) bounds.push([latOf(v), lonOf(v)]);
  });
  // não força refit continuamente; o usuário pode se mover no mapa
}
setInterval(()=>tickMany(getSelectedIds()), 2000);

/* ====== SSE (opcional) – se sua infra suportar stream ======
   Seu /api/telemetry/stream envia um ARRAY; tratamos assim */
const statusEl = document.getElementById('status');
try{
  const es = new EventSource('/api/telemetry/stream');
  es.onmessage = (ev)=>{
    // server envia: [{"vehicle_id":..,"lat":..,"lon":..}, ...]
    try{
      const payload = JSON.parse(ev.data);
      if(Array.isArray(payload)){
        payload.forEach(d=>{
          // só atualiza se estiver selecionado
          const id = d.vehicle_id;
          if(getSelectedIds().includes(Number(id))){
            upsertMarkerFromObj(d);
          }
        });
      }else{
        // compat se um único objeto vier por engano
        upsertMarkerFromObj(payload);
      }
      statusEl.textContent = 'tempo real (SSE)';
    }catch(e){}
  };
  es.onerror = ()=>{ statusEl.textContent = 'modo polling'; };
}catch(e){
  statusEl.textContent = 'modo polling';
}

/* ====== TRAÇADO (histórico simples por veículo) ======
   Chama /api/telemetry/<vehicleId> se você tiver esse endpoint.
   (Se não tiver, simplesmente não fará nada.) */
async function showTrack(vehicleId){
  try{
    const r = await fetch(`/api/telemetry/${vehicleId}`);
    if(!r.ok) return;
    const data = await r.json(); // [{lat,lon,ts,...}]
    if(trackLayer){ map.removeLayer(trackLayer); trackLayer = null; }
    if(!data.length) return;
    const latlngs = data.map(p=>[Number(p.lat), Number(p.lon)]).filter(a=>!isNaN(a[0]) && !isNaN(a[1]));
    if(!latlngs.length) return;
    trackLayer = L.polyline(latlngs, {weight:4, opacity:.9}).addTo(map);
    map.fitBounds(trackLayer.getBounds(), {padding:[30,30]});
  }catch(e){}
}

/* ====== UI ====== */
document.getElementById('fitBtn').addEventListener('click', ()=>{
  const pts = Object.values(markers).map(m=>m.getLatLng());
  if(!pts.length) return;
  const bounds = L.latLngBounds(pts);
  map.fitBounds(bounds, {padding:[30,30]});
});
</script>
</body>
</html>
